<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: func_request_new_dating.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: func_request_new_dating.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * 处理一个用户，发起约会的操作。
 * 
 * 0. 检查用户是否已经有存在的会话。
 * 1. 检查约会主题，是否存在。
 * 2. 检查用户ID，是否有效。
 * 3. 检查用户今天，发起约会的总数。
 * 4. 是否是用鲜花，发起约会。
 * 5. 创建约会Session
 * 6. 向对方，发起送一个‘私信’ 消息。
 * 7. 如果约会成功，返回约会ID。
 * 8. 失败，返回错误原因。
 * 
 */


/**
 * 报名参加一个约会主题。
 * 
 * @method request_new_dating
 * @param {String} topic_id -- 约会主题ID。
 * @param {String} user_id -- 参加约会的用户ID。
 * 
 * @return {Object} 返回约会状态和 session_id
 */
AV.Cloud.define("request_new_dating", function(request, response) {
  var topic_id = request.params.topic_id;
  var user_id = request.params.user_id;
  
  var Topic = AV.Object.extend("DatingTopic");
  var Session = AV.Object.extend("DatingSession");

  var t = new Topic();
  t.id = topic_id;
  var u = new AV.User();
  u.id = user_id;
  
  console.log("topic_id:" + topic_id + ", user_id:" + user_id);
  
  /*
   * 新创建的DatingSession
   * Dating session
   */
  var ds = {'status': 'new'};
  
  var result = {};
  new AV.Query(Session).equalTo("topic", t).equalTo('send_user', u).first()
  .then(function(obj){
	  if(obj){
		  console.log("has send topic info:" + obj);

		  result.status = 'has_sent';
		  result.dating_session_id = obj.id;
		  result.session_status = obj.get('status');
		  return AV.Promise.error();
	  }else {
		  console.log("query topic info:" + obj);
		  return new AV.Query(Topic).include("user_obj").get(topic_id);
	  }
  }, function(obj){
	  return new AV.Query(Topic).include("user_obj").get(topic_id);	  
  })
  .then(function(obj){
	  
	  if(obj){
		  console.log("topic info:" + obj.get('user_name') + ", obj:" + obj);
		  ds.topic = obj;
		  return new AV.Query(AV.User).get(user_id);
	  }else {
		  result.status = 'err';
		  result.code = 'not_found_topic';
	  }
  })
  .then(function(user){
	  if(user){
		  ds.send_user = user;
		  var t = new Date();
		  t.setHours(0);
		  t.setMinutes(0);
		  t.setSeconds(0);
		  
		  //console.log("today time:" + t);
		  return new AV.Query(Session).equalTo('send_user', u)
		   .greaterThan('createdAt', t)
		   .count();
	  }else {
		  result.status = 'err';
		  result.code = 'not_found_user';
	  }
  })
  .then(function(count){
	  //console.log("session count:" + count);
	  
	  if(count &lt;= 5 || request.params.with_flower_count > 0){
		  ds.flower_count = request.params.with_flower_count;
		  return new Session().save(ds);
	  }else {
		  result.status = 'err';
		  result.code = 'has_too_many_dating';		  
		  result.session_count = count;
	  }
  }, function(obj){
	  //console.log("get session count error:" + obj.message);
	  if(ds.send_user &amp;&amp; ds.topic){
		  ds.flower_count = request.params.with_flower_count;
		  return new Session().save(ds);
  	  }else {
  		  return AV.Promise.error();
  	  }
  })
  .then(function(obj){
	  if(obj){
		  result.status = 'ok';
		  result.dating_session_id = obj.id;
		  var user = ds.topic.get('user_obj');
		  var ss = AV.Cloud.run("send_message", {'to_user': user.id,
			  'from_user': user_id, 
			  'msg_type': 'new_session',
			  'session_id': obj.id
			  });
		  
		  if(request.params.with_flower_count > 0){
			  AV.Cloud.run("send_message", {'to_user': ds.topic.user_obj.id,
				  'from_user': user_id, 
				  'msg_type': 'send_flower',
				  'flower_count': request.params.with_flower_count
				  });
		  }
		  
		  return ss;
	  }else {
		  result.status = 'err';
		  result.code = 'save_session_error';
	  }
  })
  .then(function(obj){
	  response.success(result);	  
  }, function(obj){
	  console.log("error:" + obj);
	  
	  if(result.status == 'ok'){
		  result.status = 'err';
	  }
	  result.data = obj;
	  response.success(result);
  })
  ;
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Global</h3><ul><li><a href="global.html#dating_session_status">dating_session_status</a></li><li><a href="global.html#dating_session_update_status">dating_session_update_status</a></li><li><a href="global.html#dating_topic_list">dating_topic_list</a></li><li><a href="global.html#dating_topic_update_status">dating_topic_update_status</a></li><li><a href="global.html#invite_friend">invite_friend</a></li><li><a href="global.html#ranking_cate_list">ranking_cate_list</a></li><li><a href="global.html#ranking_data_list">ranking_data_list</a></li><li><a href="global.html#request_new_dating">request_new_dating</a></li><li><a href="global.html#send_message">send_message</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Sun Aug 03 2014 15:14:47 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
