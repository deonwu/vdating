<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: func_dating_topic_list.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: func_dating_topic_list.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * 处理一个用户，消息发送。
 * 1. 检查是否有权限，
 * 2. 
 * 
 */

  function convert_user_item(item){
	  var data = {};
	  
	  data.id = item.id; //get('name');		
	  data.username = item.get('username');

	  data.name = item.get('name');
	  data.head_img = item.get('headImg').thumbnailURL(60, 60);
	  data.gender = item.get('gender');
	  data.got_flower = item.get('got_flower');
	  data.has_flower = item.get('has_flower');
	  data.sent_flower = item.get('sent_flower');

	  data.dating_ok_count = item.get('dating_ok_count');
	  data.dating_failed_count = item.get('dating_failed_count');
	  
	  return data;
  }
  
  function convert_topic_item(item){
	  var user = item.get('user_obj');
	  if(!user) return null;
	  var data = {};
	  data.pay_price = item.get('pay_price');
	  data.period = item.get('period');
	  data.topic = item.get('topic');
	  data.user_gender = item.get('user_gender');
	  data.location = item.get('location');
	  data.location_type = item.get('location_type');
	  data.topic_desc = item.get('topic_desc');
	  data.pay_type = item.get('pay_type');
	  
	  var p = item.get('location_point');
	  data.location_point = {'latitude': p.latitude, 
			  				'longitude': p.longitude}; //item.get('location_point');
	  data.dating_time = item.get('dating_time').getTime();
	  data.updatedAt = item.updatedAt.getTime();

	  data.id = item.id;
	  //data.dating_time = item.get('dating_time').getTime();
	  
	  data.user_obj = convert_user_item(user);
	  
	  return data;
  }

/**
 * 查询约会主题列表
 * 
 * @method dating_topic_list
 * @param {String} location_type 约会位置，bar, hotel
 * @param {int} page_size 返回记录的条数
 * @param {int} page_no 返回记录的页数
 * 
 * @return {Object} 对象列表
 */
AV.Cloud.define("dating_topic_list", function(request, response) {
	
	  var topic = AV.Object.extend("DatingTopic");
	  	  
	  var result = {'status': 'ok'};
	  var data = {};
	  
	  
	  var curUser = AV.User.current();
	  
	  if(!curUser){
		  var curUser = new AV.User();
		  curUser.id = request.params.user_id;
	  }
	  
	  var pageSize = request.params.page_size || 10;
	  var pageNo = request.params.page_no || 0;
	  pageSize = parseInt(pageSize);	  
	  pageNo = parseInt(pageNo);
	  
	  var query = new AV.Query(topic).include("user_obj")
	  .include("user_obj.headImg")
	  .skip(pageNo * pageSize)
	  .limit(pageSize);
	  
	  var gender = curUser.get('user_gender');
	  if(gender){
		  query = query.equalTo('user_gender', gender == 'F' ? 'M': 'F');
	  }
	  
	  if(request.params.location_type &amp;&amp; request.params.location_type != 'all'){
		  query = query.equalTo('location_type', request.params.location_type);
	  }
	  
	  if(request.params.p_latitude &amp;&amp; request.params.p_longitude){
		  var p = new AV.GeoPoint(parseFloat(request.params.p_latitude), 
				  				  parseFloat(request.params.p_longitude));
		  query = query.withinKilometers("location_point", p, 50);
	  }
	  
	  var friends = new AV.Query(AV.Object.extend("InviteFriend"));
	  friends.select("blacklist").equalTo("owner", curUser).first()
	  .then(function(obj){
		  if(obj){
			  var blacklist = obj.get("blacklist");
			  
			  //console.log("list:" + blacklist);
			  if(blacklist){
				  var ulist = new AV.Query(AV.Object.extend("_User"));
				  ulist.containedIn("username", blacklist);
				  query = query.doesNotMatchQuery("user_obj", ulist);
			  }
		  }
		  return AV.Promise.as();
	  }).then(function(obj){
	  
		 return query.find()
			  .then(function(results){
				  if(results){
					  var items = [];
					  for(var i = 0; i &lt; results.length; i++){
						  item = results[i];
						  var obj = convert_topic_item(item);
						  if(obj){
							  items[items.length] = obj;
						  }
					  }
					  result.data = items;
				  }else {
					  result.status = 'err';
					  result.code = 'not_found_from_session';
				  }
			  })
			  .then(function(obj){
				  response.success(result);	  
			  }, function(obj){
				  console.log("error:" + (obj ? obj.toString(): ""));
				  
				  if(result.status == 'ok'){
					  result.status = 'err';
				  }
				  result.data = obj;
				  response.success(result);
			  });
		}
	  )
	  ;	  
});

AV.Cloud.define("dating_my_topic_list", function(request, response) {
	
	  var topic = AV.Object.extend("DatingTopic");
	  	  
	  var result = {'status': 'ok'};
	  var data = {};
	  
	  
	  var curUser = AV.User.current();
	  
	  if(!curUser){
		  var curUser = new AV.User();
		  curUser.id = request.params.user_id;
	  }
	  
	  var pageSize = request.params.page_size || 10;
	  var pageNo = request.params.page_no || 0;
	  pageSize = parseInt(pageSize);	  
	  pageNo = parseInt(pageNo);
	  
	  var query = new AV.Query(topic).include("user_obj")
	  .equalTo('user_obj', curUser)
	  .notEqualTo('status', "removed")
	  .include("user_obj.headImg")
	  .skip(pageNo * pageSize)
	  .limit(pageSize)
	  .descending("createdAt")
	  ;
	  	  
	  query.find()
	  .then(function(results){
		  if(results){
			  var items = [];
			  for(var i = 0; i &lt; results.length; i++){
				  item = results[i];
				  var obj = convert_topic_item(item);
				  if(obj){
					  items[items.length] = obj;
				  }
			  }
			  result.data = items;
		  }else {
			  result.status = 'err';
			  result.code = 'not_found_from_session';
		  }
	  })
	  .then(function(obj){
		  response.success(result);	  
	  }, function(obj){
		  console.log("error:" + (obj ? obj.toString(): ""));
		  
		  if(result.status == 'ok'){
			  result.status = 'err';
		  }
		  result.data = obj;
		  response.success(result);
	  })
	  ;	  
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Global</h3><ul><li><a href="global.html#dating_session_status">dating_session_status</a></li><li><a href="global.html#dating_topic_list">dating_topic_list</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Wed Jul 16 2014 18:29:55 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
